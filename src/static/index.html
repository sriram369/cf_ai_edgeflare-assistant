<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>EdgeFlare AI Assistant</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 700px; margin: 40px auto; }
    #chat { border: 1px solid #ddd; padding: 16px; min-height: 300px; }
    .msg.user { text-align: right; color: #111; }
    .msg.assistant { text-align: left; color: #0b63c6; }
    #input { width: calc(100% - 110px); padding: 8px; }
    #send { padding: 8px 12px; }
  </style>
</head>
<body>
  <h1>EdgeFlare AI Assistant</h1>
  <div id="chat"></div>
  <div style="margin-top:12px;">
    <input id="input" placeholder="Ask anything..." />
    <button id="send">Send</button>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    // find or create session stored in localStorage
    let sessionId = localStorage.getItem('ef_session');
    async function createSession() {
      const res = await fetch('/api/session', { method: 'POST' });
      const j = await res.json();
      sessionId = j.sessionId;
      localStorage.setItem('ef_session', sessionId);
      return sessionId;
    }

    async function ensureSession() {
      if (!sessionId) {
        await createSession();
      }
    }

    async function loadHistory() {
      await ensureSession();
      const res = await fetch(`/api/chat?sid=${sessionId}`);
      if (res.status === 200) {
        const history = await res.json();
        chatEl.innerHTML = '';
        history.forEach(m => {
          const d = document.createElement('div');
          d.className = 'msg ' + m.role;
          d.textContent = (m.role === 'user' ? 'You: ' : 'Assistant: ') + m.content;
          chatEl.appendChild(d);
        });
        chatEl.scrollTop = chatEl.scrollHeight;
      }
    }

    sendBtn.onclick = async () => {
      const text = inputEl.value.trim();
      if (!text) return;
      // append user msg locally
      const userDiv = document.createElement('div');
      userDiv.className = 'msg user';
      userDiv.textContent = 'You: ' + text;
      chatEl.appendChild(userDiv);
      inputEl.value = '';

      await ensureSession();

      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionId: sessionId, message: text })
      });

      const j = await res.json();
      const assistant = j.reply || 'No reply';
      const aDiv = document.createElement('div');
      aDiv.className = 'msg assistant';
      aDiv.textContent = 'Assistant: ' + assistant;
      chatEl.appendChild(aDiv);
      chatEl.scrollTop = chatEl.scrollHeight;
    };

    window.onload = loadHistory;
  </script>
</body>
</html>
